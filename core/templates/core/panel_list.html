{% extends "base.html" %}
{% block title %}–û–±—ä–µ–∫—Ç—ã ‚Äî –ú–∏–Ω–∏-CRM{% endblock %}
{% block extra_head %}
  {{ block.super }}
  <style>
    .panel-table .addr-link { text-decoration: underline; color: inherit; }
    .panel-table .type-line { font-weight: 600; }
    .panel-table .chips-line { display: flex; gap: .25rem; margin-top: .15rem; flex-wrap: wrap; }
    .panel-table .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); border: 0; }
  </style>
{% endblock %}

{% block content %}
<div class="topbar">
  <h1>–û–±—ä–µ–∫—Ç—ã</h1>
  <a href="{% url 'panel_new' %}" class="btn btn-sm">+ –°–æ–∑–¥–∞—Ç—å –æ–±—ä–µ–∫—Ç</a>
  <form method="get" action="{% url 'panel_list' %}" class="panel-search" autocomplete="off">
    <input type="text" name="q" value="{{ q }}" placeholder="–ü–æ–∏—Å–∫" />
    <button type="submit" class="btn btn-sm" title="–ù–∞–π—Ç–∏">üîé</button>
    <label class="arch-toggle">
      <input type="checkbox" name="include_archived" value="1" {% if include_archived %}checked{% endif %}>
      <span>–ê—Ä—Ö.</span>
    </label>
    {% if show %}<input type="hidden" name="show" value="{{ show }}">{% endif %}
  </form>
  <a href="{% url 'export_cian_check' %}" class="btn btn-sm">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–µ—Ä–µ–¥ —ç–∫—Å–ø–æ—Ä—Ç–æ–º</a>
  <a href="{% url 'export_cian' %}" class="btn btn-sm">CIAN —Ñ–∏–¥</a>
  <a href="{% url 'export_domklik' %}" class="btn btn-sm">DomClick —Ñ–∏–¥</a>
</div>

<div class="table-wrap panel-table-wrap">
  <table class="tbl panel-table">
    <thead>
      <tr>
        <th class="col-type">–¢–∏–ø</th>
        <th class="col-address">–ê–¥—Ä–µ—Å</th>
        <th class="col-price">–¶–µ–Ω–∞</th>
        <th class="col-floor">—ç—Ç.</th>
        <th class="col-actions">–î–µ–π—Å—Ç–≤–∏—è</th>
        <th class="col-dates">–î–∞—Ç—ã</th>
      </tr>
    </thead>
    <tbody>
    {% for row in rows %}
      <tr
        data-id="{{ row.id }}"
        data-price-url="{% url 'panel_update_price' row.id %}"
        data-archive-url="{% url 'panel_toggle_archive' row.id %}"
        data-delete-url="{% url 'panel_delete' row.id %}"
        data-toggle-cian-url="{% url 'panel_toggle_export_cian' row.id %}"
        data-toggle-dom-url="{% url 'panel_toggle_export_dom' row.id %}"
        class="{% if row.is_archived %}is-archived{% endif %}"
      >
        <td class="col-type">
          <div class="type-line">{{ row.type|default:"" }}</div>
          <div class="chips-line">
            <span class="chip {% if row.export_to_cian %}on cian{% else %}off{% endif %}" data-action="toggle-cian">CIAN</span>
            <span class="chip {% if row.export_to_domklik %}on dom{% else %}off{% endif %}" data-action="toggle-dom">Dom</span>
          </div>
          {% if row.external_id %}<span class="sr-only external-id">{{ row.external_id }}</span>{% endif %}
        </td>
        <td class="addr" title="{{ row.full_address|default:row.address }}">
          <a class="addr-link" href="{% url 'panel_edit' row.id %}">{{ row.address|default:"‚Äî" }}</a>
        </td>
        <td class="price-cell" data-price-raw="{{ row.price_raw }}">
          <span class="price-text">{{ row.price_display|default:"‚Äî" }}</span>
        </td>
        <td class="col-floor">{{ row.floors }}</td>
        <td class="col-actions">
          <a href="{% url 'panel_edit' row.id %}" class="btn btn-sm">–û—Ç–∫—Ä—ã—Ç—å</a>
          {% if row.is_archived %}
            <button type="button" class="btn btn-sm act-restore">–í–ï–†–ù</button>
          {% else %}
            <button type="button" class="btn btn-sm act-archive">–ê–†–•</button>
          {% endif %}
          <button type="button" class="btn btn-sm btn-danger act-delete" title="–£–¥–∞–ª–∏—Ç—å">‚úñ</button>
        </td>
        <td class="dates">
          <div>–∏–∑–º {{ row.updated|default:"‚Äî" }}</div>
          <div>–¥–æ–± {{ row.created|default:"‚Äî" }}</div>
        </td>
      </tr>
    {% empty %}
      <tr><td colspan="6">–ü–æ–∫–∞ –Ω–µ—Ç –æ–±—ä–µ–∫—Ç–æ–≤</td></tr>
    {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}

{% block extra_scripts %}
  {{ block.super }}
  <script>
    (function () {
      const table = document.querySelector('.panel-table');
      if (!table) {
        return;
      }

      const getCookie = (name) => {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) {
          return parts.pop().split(';').shift();
        }
        return '';
      };

      const csrftoken = getCookie('csrftoken');

      const post = (url, data) => {
        return fetch(url, {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrftoken,
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
          },
          body: new URLSearchParams(data || {}),
        }).then((response) => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.json();
        });
      };

      const searchForm = document.querySelector('.panel-search');
      if (searchForm) {
        const includeArchivedInput = searchForm.querySelector('input[name="include_archived"]');
        if (includeArchivedInput) {
          includeArchivedInput.addEventListener('change', () => {
            searchForm.submit();
          });
        }
      }

      const formatSpaces = (value) => {
        const digits = String(value || '').replace(/\D/g, '');
        if (!digits) {
          return '‚Äî';
        }
        return digits.replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
      };

      const startPriceEdit = (cell) => {
        if (cell.classList.contains('editing')) {
          return;
        }
        const row = cell.closest('tr');
        if (!row) {
          return;
        }
        const url = row.dataset.priceUrl;
        if (!url) {
          return;
        }
        const originalRaw = cell.dataset.priceRaw || '';
        const originalHTML = cell.innerHTML;
        cell.classList.add('editing');
        cell.innerHTML = '';

        const input = document.createElement('input');
        input.type = 'number';
        input.min = '0';
        input.value = originalRaw;
        input.style.width = '120px';

        const okBtn = document.createElement('button');
        okBtn.type = 'button';
        okBtn.className = 'btn btn-sm';
        okBtn.textContent = '‚úî';

        const cancelBtn = document.createElement('button');
        cancelBtn.type = 'button';
        cancelBtn.className = 'btn btn-sm';
        cancelBtn.textContent = '‚úñ';

        const wrapper = document.createElement('div');
        wrapper.style.display = 'flex';
        wrapper.style.alignItems = 'center';
        wrapper.style.gap = '.25rem';
        wrapper.append(input, okBtn, cancelBtn);
        cell.append(wrapper);
        input.focus();

        const rollback = () => {
          cell.innerHTML = originalHTML;
          cell.classList.remove('editing');
        };

        const updateCell = (raw, display) => {
          const span = document.createElement('span');
          span.className = 'price-text';
          span.textContent = display || '‚Äî';
          cell.dataset.priceRaw = raw || '';
          cell.innerHTML = '';
          cell.append(span);
          cell.classList.remove('editing');
        };

        okBtn.addEventListener('click', () => {
          post(url, { price: input.value || '' })
            .then((data) => {
              if (!data || !data.ok) {
                throw new Error('Invalid response');
              }
              updateCell(data.price || '', data.price_display || data.price_formatted || formatSpaces(data.price));
            })
            .catch(() => {
              rollback();
              alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ü–µ–Ω—É');
            });
        });

        cancelBtn.addEventListener('click', rollback);
        input.addEventListener('keydown', (event) => {
          if (event.key === 'Enter') {
            event.preventDefault();
            okBtn.click();
          }
          if (event.key === 'Escape') {
            event.preventDefault();
            rollback();
          }
        });
      };

      table.querySelectorAll('td.price-cell').forEach((cell) => {
        cell.addEventListener('click', (event) => {
          if (event.target.closest('button')) {
            return;
          }
          startPriceEdit(cell);
        });
      });

      const updateArchiveButton = (button, isArchived) => {
        if (!button) {
          return;
        }
        button.textContent = isArchived ? '–í–ï–†–ù' : '–ê–†–•';
        button.classList.toggle('act-archive', !isArchived);
        button.classList.toggle('act-restore', isArchived);
      };

      table.addEventListener('click', (event) => {
        const archiveBtn = event.target.closest('.act-archive, .act-restore');
        if (archiveBtn) {
          const row = archiveBtn.closest('tr');
          if (!row) {
            return;
          }
          const url = row.dataset.archiveUrl;
          if (!url) {
            return;
          }
          post(url)
            .then((data) => {
              if (!data || !data.ok) {
                throw new Error('Invalid response');
              }
              const archived = !!data.is_archived;
              row.classList.toggle('is-archived', archived);
              updateArchiveButton(archiveBtn, archived);
            })
            .catch(() => alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –æ–±—ä–µ–∫—Ç–∞'));
          return;
        }

        const deleteBtn = event.target.closest('.act-delete');
        if (deleteBtn) {
          const row = deleteBtn.closest('tr');
          if (!row) {
            return;
          }
          if (!confirm('–£–¥–∞–ª–∏—Ç—å –æ–±—ä–µ–∫—Ç –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ?')) {
            return;
          }
          const url = row.dataset.deleteUrl;
          if (!url) {
            return;
          }
          post(url)
            .then((data) => {
              if (!data || !data.ok && !data.deleted) {
                throw new Error('Invalid response');
              }
              row.remove();
            })
            .catch(() => alert('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –æ–±—ä–µ–∫—Ç'));
          return;
        }

        const chip = event.target.closest('.chip');
        if (chip) {
          const row = chip.closest('tr');
          if (!row) {
            return;
          }
          const action = chip.dataset.action;
          const url = action === 'toggle-cian' ? row.dataset.toggleCianUrl : row.dataset.toggleDomUrl;
          if (!url) {
            return;
          }
          post(url)
            .then((data) => {
              if (!data || !data.ok) {
                throw new Error('Invalid response');
              }
              if (Object.prototype.hasOwnProperty.call(data, 'export_to_cian')) {
                const cianChip = row.querySelector('.chip[data-action="toggle-cian"]');
                if (cianChip) {
                  cianChip.classList.toggle('on', !!data.export_to_cian);
                  cianChip.classList.toggle('off', !data.export_to_cian);
                }
              }
              if (Object.prototype.hasOwnProperty.call(data, 'export_to_domklik')) {
                const domChip = row.querySelector('.chip[data-action="toggle-dom"]');
                if (domChip) {
                  domChip.classList.toggle('on', !!data.export_to_domklik);
                  domChip.classList.toggle('off', !data.export_to_domklik);
                }
              }
            })
            .catch(() => alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞'));
        }
      });
    })();
  </script>
{% endblock %}
