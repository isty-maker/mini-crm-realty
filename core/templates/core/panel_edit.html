{% extends "base.html" %}
{% load static %}
{% block title %}{{ prop|default:"Новый объект" }} — Мини-CRM{% endblock %}
{% block content %}
  <a href="/panel/">&larr; к списку</a>
  <h1>{{ prop|default:"Новый объект" }}</h1>

  <form id="prop-form" method="post" action="{{ request.get_full_path }}">
    {% csrf_token %}
    {% if form.errors %}
      <div class="alert alert-danger">
        <strong>Исправьте ошибки:</strong>
        <ul>
        {% for field, errors in form.errors.items %}
          <li>{{ field }}: {{ errors|join:', ' }}</li>
        {% endfor %}
        </ul>
      </div>
    {% endif %}
    <div id="subtypes-data"
         data-subtypes='{{ subtypes_map_json|default:"{}"|safe }}'
         data-placeholder="{{ subtypes_placeholder }}"
         hidden></div>
    <section class="group">
      <h3>Тип и сделка</h3>
      <div class="form-row">{{ form.category.label_tag }} {{ form.category }}</div>
      <div class="form-row">{{ form.operation.label_tag }} {{ form.operation }}</div>
      <div class="form-row">{{ form.subtype.label_tag }} {{ form.subtype }}</div>
    </section>

    <section class="group">
      <h3>Экспорт</h3>
      <div class="form-row"><label>{{ form.export_to_cian }} {{ form.export_to_cian.label }}</label></div>
      <div class="form-row"><label>{{ form.export_to_domklik }} {{ form.export_to_domklik.label }}</label></div>
      <div class="form-row"><label>{{ form.is_archived }} {{ form.is_archived.label }}</label></div>
    </section>

    <!-- Общие поля (видны всегда) -->
    <section class="group">
      <h3>Основное</h3>
      <div class="form-row">{{ form.title.label_tag }} {{ form.title }}</div>
      <div class="form-row row-2">
        {{ form.price.label_tag }} {{ form.price }}
        {{ form.currency.label_tag }} {{ form.currency }}
      </div>
      <div class="form-row">{{ form.address.label_tag }} {{ form.address }}</div>
      <div class="form-row">{{ form.description.label_tag }} {{ form.description }}</div>
      <div class="form-row">
        <label>{{ form.mortgage_allowed }} {{ form.mortgage_allowed.label }}</label>
      </div>
      <div class="form-row row-2">
        <div class="form-row">
          {{ form.agent_bonus_value.label_tag }}
          {{ form.agent_bonus_value }}
        </div>
        <div class="form-row">
          <label>{{ form.agent_bonus_is_percent }} {{ form.agent_bonus_is_percent.label }}</label>
        </div>
      </div>
      <div class="form-row row-2">
        <div class="form-row">
          {{ form.security_deposit.label_tag }}
          {{ form.security_deposit }}
        </div>
        <div class="form-row">
          {{ form.min_rent_term_months.label_tag }}
          {{ form.min_rent_term_months }}
        </div>
      </div>
    </section>

    <section class="group">
      <h3>Адрес</h3>
      <div class="form-row row-2">
        <div class="form-row">
          {{ form.lat.label_tag }}
          {{ form.lat }}
        </div>
        <div class="form-row">
          {{ form.lng.label_tag }}
          {{ form.lng }}
        </div>
      </div>
      <div class="form-row">
        {{ form.cadastral_number.label_tag }}
        {{ form.cadastral_number }}
      </div>
    </section>

    <section class="group">
      <h3>Контакты</h3>
      <div class="form-row row-2">
        <div class="form-row">
          {{ form.phone_country.label_tag }}
          {{ form.phone_country }}
        </div>
        <div class="form-row">
          {{ form.phone_number.label_tag }}
          {{ form.phone_number }}
        </div>
      </div>
      <div class="form-row">
        {{ form.phone_number2.label_tag }}
        {{ form.phone_number2 }}
      </div>
    </section>

    <section class="group">
      <h3>Медиа</h3>
      <div class="form-row">
        {{ form.layout_photo_url.label_tag }}
        {{ form.layout_photo_url }}
      </div>
      <div class="form-row">
        {{ form.object_tour_url.label_tag }}
        {{ form.object_tour_url }}
      </div>
    </section>

    <section class="group">
      <h3>Здание</h3>
      <div class="form-row">
        {{ form.building_name.label_tag }}
        {{ form.building_name }}
      </div>
      <div class="form-row row-2">
        <div class="form-row">
          {{ form.building_floors.label_tag }}
          {{ form.building_floors }}
        </div>
        <div class="form-row">
          {{ form.building_build_year.label_tag }}
          {{ form.building_build_year }}
        </div>
      </div>
      <div class="form-row">
        {{ form.building_material.label_tag }}
        {{ form.building_material }}
      </div>
      <div class="form-row row-2">
        <div class="form-row">
          {{ form.building_ceiling_height.label_tag }}
          {{ form.building_ceiling_height }}
        </div>
        <div class="form-row">
          {{ form.building_passenger_lifts.label_tag }}
          {{ form.building_passenger_lifts }}
        </div>
      </div>
      <div class="form-row">
        {{ form.building_cargo_lifts.label_tag }}
        {{ form.building_cargo_lifts }}
      </div>
    </section>

    <div class="group" data-section="house">
      <h3>Параметры дома</h3>
      {% if form.fields.house_type %}
      <div class="form-row">
        <label for="{{ form.house_type.id_for_label }}">{{ form.house_type.label }}</label>
        {{ form.house_type }}
        {{ form.house_type.errors }}
      </div>
      {% endif %}
      {% with field=form.total_area %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {{ field.errors }}
      </div>
      {% endwith %}
      {% with field=form.living_area %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {{ field.errors }}
      </div>
      {% endwith %}
      {% with field=form.kitchen_area %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {{ field.errors }}
      </div>
      {% endwith %}
      {% with field=form.land_area %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {{ field.errors }}
      </div>
      {% endwith %}
      {% with field=form.land_area_unit %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {{ field.errors }}
      </div>
      {% endwith %}
      {% with field=form.permitted_land_use %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {{ field.errors }}
      </div>
      {% endwith %}
      {% with field=form.is_land_with_contract %}
      <div class="form-row">
        <label>
          {{ field }} {{ field.label }}
        </label>
        {{ field.errors }}
      </div>
      {% endwith %}
      {% with field=form.land_category %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {{ field.errors }}
      </div>
      {% endwith %}
      {% with field=form.heating_type %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {{ field.errors }}
      </div>
      {% endwith %}
      {% with field=form.has_terrace %}
      <div class="form-row">
        <label>{{ field }} {{ field.label }}</label>
        {{ field.errors }}
      </div>
      {% endwith %}
      {% with field=form.has_cellar %}
      <div class="form-row">
        <label>{{ field }} {{ field.label }}</label>
        {{ field.errors }}
      </div>
      {% endwith %}
      {% with field=form.rooms %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {{ field.errors }}
      </div>
      {% endwith %}
      {% with field=form.repair_type %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {{ field.errors }}
      </div>
      {% endwith %}
      {% with field=form.separate_wcs_count %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {{ field.errors }}
      </div>
      {% endwith %}
      {% with field=form.combined_wcs_count %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {{ field.errors }}
      </div>
      {% endwith %}
      {% with field=form.ceiling_height %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {{ field.errors }}
      </div>
      {% endwith %}
      {% with field=form.power %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {{ field.errors }}
      </div>
      {% endwith %}
      {% with field=form.has_parking %}
      <div class="form-row">
        <label>{{ field }} {{ field.label }}</label>
        {{ field.errors }}
      </div>
      {% endwith %}
      {% with field=form.parking_places %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {{ field.errors }}
      </div>
      {% endwith %}
    </div>

    <div class="group" data-section="flat">
      <h3>Квартира</h3>
      {% if form.fields.flat_type %}
      <div class="form-row">
        <label for="{{ form.flat_type.id_for_label }}">{{ form.flat_type.label }}</label>
        {{ form.flat_type }}
        {{ form.flat_type.errors }}
      </div>
      {% endif %}
      {% with field=form.total_area %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {{ field.errors }}
      </div>
      {% endwith %}
      {% with field=form.living_area %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {{ field.errors }}
      </div>
      {% endwith %}
      {% with field=form.kitchen_area %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {{ field.errors }}
      </div>
      {% endwith %}
      {% with field=form.rooms %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {{ field.errors }}
      </div>
      {% endwith %}
      {% with field=form.floor_number %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {{ field.errors }}
      </div>
      {% endwith %}
      {% with field=form.room_type %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {{ field.errors }}
      </div>
      {% endwith %}
      {% with field=form.flat_rooms_count %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {{ field.errors }}
      </div>
      {% endwith %}
      <div class="form-row row-2">
        {% with field=form.loggias_count %}
        <div class="form-row">
          <label for="{{ field.id_for_label }}">{{ field.label }}</label>
          {{ field }}
          {{ field.errors }}
        </div>
        {% endwith %}
        {% with field=form.balconies_count %}
        <div class="form-row">
          <label for="{{ field.id_for_label }}">{{ field.label }}</label>
          {{ field }}
          {{ field.errors }}
        </div>
        {% endwith %}
      </div>
      {% with field=form.windows_view_type %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {{ field.errors }}
      </div>
      {% endwith %}
      <div class="form-row row-2">
        {% with field=form.separate_wcs_count %}
        <div class="form-row">
          <label for="{{ field.id_for_label }}">{{ field.label }}</label>
          {{ field }}
          {{ field.errors }}
        </div>
        {% endwith %}
        {% with field=form.combined_wcs_count %}
        <div class="form-row">
          <label for="{{ field.id_for_label }}">{{ field.label }}</label>
          {{ field }}
          {{ field.errors }}
        </div>
        {% endwith %}
      </div>
      {% with field=form.repair_type %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {{ field.errors }}
      </div>
      {% endwith %}
      {% with field=form.is_euro_flat %}
      <div class="form-row">
        <label>{{ field }} {{ field.label }}</label>
        {{ field.errors }}
      </div>
      {% endwith %}
      {% with field=form.is_apartments %}
      <div class="form-row">
        <label>{{ field }} {{ field.label }}</label>
        {{ field.errors }}
      </div>
      {% endwith %}
      {% with field=form.is_penthouse %}
      <div class="form-row">
        <label>{{ field }} {{ field.label }}</label>
        {{ field.errors }}
      </div>
      {% endwith %}
      <div class="form-row">
        <label for="{{ form.jk_id.id_for_label }}">{{ form.jk_id.label }}</label>
        {{ form.jk_id }}
        {{ form.jk_id.errors }}
      </div>
      <div class="form-row">
        <label for="{{ form.jk_name.id_for_label }}">{{ form.jk_name.label }}</label>
        {{ form.jk_name }}
        {{ form.jk_name.errors }}
      </div>
      <div class="form-row">
        <label for="{{ form.house_id.id_for_label }}">{{ form.house_id.label }}</label>
        {{ form.house_id }}
        {{ form.house_id.errors }}
      </div>
      <div class="form-row">
        <label for="{{ form.house_name.id_for_label }}">{{ form.house_name.label }}</label>
        {{ form.house_name }}
        {{ form.house_name.errors }}
      </div>
      <div class="form-row">
        <label for="{{ form.flat_number.id_for_label }}">{{ form.flat_number.label }}</label>
        {{ form.flat_number }}
        {{ form.flat_number.errors }}
      </div>
      <div class="form-row">
        <label for="{{ form.section_number.id_for_label }}">{{ form.section_number.label }}</label>
        {{ form.section_number }}
        {{ form.section_number.errors }}
      </div>
    </div>

    <div class="group" data-section="room">
      <h3>Комната</h3>
      {% if form.fields.room_type_ext %}
      <div class="form-row">
        <label for="{{ form.room_type_ext.id_for_label }}">{{ form.room_type_ext.label }}</label>
        {{ form.room_type_ext }}
        {{ form.room_type_ext.errors }}
      </div>
      {% endif %}
      {% with field=form.total_area %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {{ field.errors }}
      </div>
      {% endwith %}
      {% with field=form.living_area %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {{ field.errors }}
      </div>
      {% endwith %}
      {% with field=form.rooms %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {{ field.errors }}
      </div>
      {% endwith %}
      {% with field=form.floor_number %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {{ field.errors }}
      </div>
      {% endwith %}
      {% with field=form.room_type %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {{ field.errors }}
      </div>
      {% endwith %}
      <div class="form-row row-2">
        {% with field=form.separate_wcs_count %}
        <div class="form-row">
          <label for="{{ field.id_for_label }}">{{ field.label }}</label>
          {{ field }}
          {{ field.errors }}
        </div>
        {% endwith %}
        {% with field=form.combined_wcs_count %}
        <div class="form-row">
          <label for="{{ field.id_for_label }}">{{ field.label }}</label>
          {{ field }}
          {{ field.errors }}
        </div>
        {% endwith %}
      </div>
      {% with field=form.repair_type %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {{ field.errors }}
      </div>
      {% endwith %}
      <div class="form-row">
        <label for="{{ form.jk_id.id_for_label }}">{{ form.jk_id.label }}</label>
        {{ form.jk_id }}
        {{ form.jk_id.errors }}
      </div>
      <div class="form-row">
        <label for="{{ form.jk_name.id_for_label }}">{{ form.jk_name.label }}</label>
        {{ form.jk_name }}
        {{ form.jk_name.errors }}
      </div>
      <div class="form-row">
        <label for="{{ form.house_id.id_for_label }}">{{ form.house_id.label }}</label>
        {{ form.house_id }}
        {{ form.house_id.errors }}
      </div>
      <div class="form-row">
        <label for="{{ form.house_name.id_for_label }}">{{ form.house_name.label }}</label>
        {{ form.house_name }}
        {{ form.house_name.errors }}
      </div>
      <div class="form-row">
        <label for="{{ form.flat_number.id_for_label }}">{{ form.flat_number.label }}</label>
        {{ form.flat_number }}
        {{ form.flat_number.errors }}
      </div>
      <div class="form-row">
        <label for="{{ form.section_number.id_for_label }}">{{ form.section_number.label }}</label>
        {{ form.section_number }}
        {{ form.section_number.errors }}
      </div>
    </div>

    <div class="group" data-section="commercial">
      <h3>Коммерция</h3>
      {% if form.fields.commercial_type %}
      <div class="form-row">
        <label for="{{ form.commercial_type.id_for_label }}">{{ form.commercial_type.label }}</label>
        {{ form.commercial_type }}
        {{ form.commercial_type.errors }}
      </div>
      {% endif %}
      {% with field=form.total_area %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {{ field.errors }}
      </div>
      {% endwith %}
      {% with field=form.ceiling_height %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {{ field.errors }}
      </div>
      {% endwith %}
      {% with field=form.power %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {{ field.errors }}
      </div>
      {% endwith %}
      {% with field=form.has_parking %}
      <div class="form-row">
        <label>{{ field }} {{ field.label }}</label>
        {{ field.errors }}
      </div>
      {% endwith %}
      {% with field=form.parking_places %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {{ field.errors }}
      </div>
      {% endwith %}
      {% with field=form.has_ramp %}
      <div class="form-row">
        <label>{{ field }} {{ field.label }}</label>
        {{ field.errors }}
      </div>
      {% endwith %}
      {% with field=form.is_rent_by_parts %}
      <div class="form-row">
        <label>{{ field }} {{ field.label }}</label>
        {{ field.errors }}
      </div>
      {% endwith %}
      {% with field=form.rent_by_parts_desc %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {{ field.errors }}
      </div>
      {% endwith %}
    </div>

    <div class="group" data-section="land">
      <h3>Земельный участок</h3>
      {% if form.fields.land_type %}
      <div class="form-row">
        <label for="{{ form.land_type.id_for_label }}">{{ form.land_type.label }}</label>
        {{ form.land_type }}
        {{ form.land_type.errors }}
      </div>
      {% endif %}
      {% with field=form.land_area %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {{ field.errors }}
      </div>
      {% endwith %}
      {% with field=form.land_area_unit %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {{ field.errors }}
      </div>
      {% endwith %}
      {% with field=form.permitted_land_use %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {{ field.errors }}
      </div>
      {% endwith %}
      {% with field=form.land_category %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {{ field.errors }}
      </div>
      {% endwith %}
      {% with field=form.is_land_with_contract %}
      <div class="form-row">
        <label>{{ field }} {{ field.label }}</label>
        {{ field.errors }}
      </div>
      {% endwith %}
    </div>

    <div class="group" data-section="garage">
      <h3>Гараж</h3>
      {% with field=form.total_area %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {{ field.errors }}
      </div>
      {% endwith %}
      {% with field=form.has_parking %}
      <div class="form-row">
        <label>{{ field }} {{ field.label }}</label>
        {{ field.errors }}
      </div>
      {% endwith %}
      {% with field=form.parking_places %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {{ field.errors }}
      </div>
      {% endwith %}
    </div>

    <section class="group">
      <h3>Удобства</h3>
      <div class="form-row">
        <label for="{{ form.furnishing_details.id_for_label }}">{{ form.furnishing_details.label }}</label>
        {{ form.furnishing_details }}
        {{ form.furnishing_details.errors }}
      </div>
      <div class="form-row">
        <label>{{ form.has_internet }} {{ form.has_internet.label }}</label>
      </div>
      <div class="form-row">
        <label>{{ form.has_furniture }} {{ form.has_furniture.label }}</label>
      </div>
      <div class="form-row">
        <label>{{ form.has_kitchen_furniture }} {{ form.has_kitchen_furniture.label }}</label>
      </div>
      <div class="form-row">
        <label>{{ form.has_tv }} {{ form.has_tv.label }}</label>
      </div>
      <div class="form-row">
        <label>{{ form.has_washer }} {{ form.has_washer.label }}</label>
      </div>
      <div class="form-row">
        <label>{{ form.has_conditioner }} {{ form.has_conditioner.label }}</label>
      </div>
      <div class="form-row">
        <label>{{ form.has_refrigerator }} {{ form.has_refrigerator.label }}</label>
      </div>
      <div class="form-row">
        <label>{{ form.has_dishwasher }} {{ form.has_dishwasher.label }}</label>
      </div>
      <div class="form-row">
        <label>{{ form.has_shower }} {{ form.has_shower.label }}</label>
      </div>
      <div class="form-row">
        <label>{{ form.has_phone }} {{ form.has_phone.label }}</label>
      </div>
      <div class="form-row">
        <label>{{ form.has_bathtub }} {{ form.has_bathtub.label }}</label>
      </div>
    </section>

    <button type="submit">Сохранить</button>
  </form>

  {% if prop %}
    <h3>Фотографии</h3>
    <form method="post" action="/panel/edit/{{ prop.pk }}/add-photo/" enctype="multipart/form-data">
      {% csrf_token %}
      <input type="file" name="image" required>
      <label><input type="checkbox" name="is_main"> Сделать главной</label>
      <button>Загрузить</button>
    </form>

    <div class="photos" style="margin-top:1rem">
      {% for ph in photos %}
        <figure>
          <img src="{{ ph.image_url }}" alt="photo {{ forloop.counter }}">
          <figcaption>
            {% if ph.is_main %}
              <span class="tag">главное</span>
            {% else %}
              <form method="post" action="/panel/photo/{{ ph.pk }}/make-main/" style="display:inline">
                {% csrf_token %}<button class="secondary">Сделать главным</button>
              </form>
            {% endif %}
            <form method="post" action="/panel/photo/{{ ph.pk }}/delete/" style="display:inline">
              {% csrf_token %}<button class="contrast">Удалить</button>
            </form>
          </figcaption>
        </figure>
      {% empty %}
      <p class="muted">Фото пока нет</p>
      {% endfor %}
    </div>
  {% endif %}
{% endblock %}

{% block extra_scripts %}
  {{ block.super }}
  <script src="{% static 'core/form.js' %}"></script>
{% endblock %}
