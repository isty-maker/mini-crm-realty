{% extends "base.html" %}
{% load static %}
{% block title %}{{ prop|default:"Новый объект" }} — Мини-CRM{% endblock %}
{% block content %}
  <a href="/panel/">&larr; к списку</a>
  <h1>{{ prop|default:"Новый объект" }}</h1>

  <form id="prop-form" method="post" action="{% if prop %}{% url 'panel_edit' pk=prop.id %}{% else %}{% url 'panel_create' %}{% endif %}" data-preserve-scroll="true">
    {% csrf_token %}
    {{ form.non_field_errors }}
    {% for hidden in form.hidden_fields %}
      {{ hidden }}
    {% endfor %}
    {% if form.errors %}
      <div class="alert alert-danger">
        <strong>Исправьте ошибки:</strong>
        <ul>
        {% for field in form %}
          {% if field.errors %}
            <li><a href="#{{ field.id_for_label }}">{{ field.label }}:</a> {{ field.errors|join:", " }}</li>
          {% endif %}
        {% endfor %}
        {% if form.non_field_errors %}
          {% for e in form.non_field_errors %}
            <li>{{ e }}</li>
          {% endfor %}
        {% endif %}
        </ul>
      </div>
    {% endif %}
    <div id="subtypes-data"
         data-subtypes='{{ subtypes_map_json|default:"{}"|safe }}'
         data-placeholder="{{ subtypes_placeholder }}"
         hidden></div>
    <section class="group">
      <h3>Тип и сделка</h3>
      {% with field=form.category %}
      <div class="form-row">
        {{ field.label_tag }} {{ field }}
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.operation %}
      <div class="form-row">
        {{ field.label_tag }} {{ field }}
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.subtype %}
      <div class="form-row">
        {{ field.label_tag }} {{ field }}
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
    </section>

    <section class="group">
      <h3>Экспорт</h3>
      {% with field=form.status %}
      <div class="form-row">
        {{ field.label_tag }} {{ field }}
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.export_to_cian %}
      <div class="form-row">
        <label>{{ field }} {{ field.label }}</label>
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.export_to_domklik %}
      <div class="form-row">
        <label>{{ field }} {{ field.label }}</label>
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.is_archived %}
      <div class="form-row">
        <label>{{ field }} {{ field.label }}</label>
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
    </section>

    <section class="group">
      <h3>Карточка</h3>
      {% with field=form.title %}
      <div class="form-row">
        {{ field.label_tag }} {{ field }}
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
    </section>

    {% for group_title, fields in field_groups %}
      <section class="group">
        <h3>{{ group_title }}</h3>
        {% for field in fields %}
          {% if not field.is_hidden %}
          <div class="form-row">
            {% if field.field.widget.input_type == "checkbox" %}
              <label>{{ field }} {{ field.label }}</label>
            {% else %}
              {{ field.label_tag }} {{ field }}
            {% endif %}
            {% include "core/includes/field_errors.html" %}
          </div>
          {% endif %}
        {% endfor %}
      </section>
    {% endfor %}

    {% if field_fallback %}
    <section class="group">
      <h3>Прочее</h3>
      {% for field in field_fallback %}
        {% if not field.is_hidden %}
        <div class="form-row">
          {% if field.field.widget.input_type == "checkbox" %}
            <label>{{ field }} {{ field.label }}</label>
          {% else %}
            {{ field.label_tag }} {{ field }}
          {% endif %}
          {% include "core/includes/field_errors.html" %}
        </div>
        {% endif %}
      {% endfor %}
    </section>
    {% endif %}
    <button type="submit">Сохранить</button>
  </form>

  {% if prop %}
    <hr>
    <h3>Фотографии</h3>
    <form method="post" action="{% url 'panel_add_photo' pk=prop.id %}" enctype="multipart/form-data" data-preserve-scroll="true">
      {% csrf_token %}
      <div class="form-row">
        <label>Файлы (можно выбрать несколько)</label>
        <input type="file" id="images-input" name="images" multiple accept="image/*">
        <div id="images-preview" class="photos" style="margin-top:.5rem;"></div>
        <script>
          const input = document.getElementById('images-input');
          const box   = document.getElementById('images-preview');
          if (input && box) {
            input.addEventListener('change', () => {
              box.innerHTML = '';
              Array.from(input.files || []).forEach(f => {
                const url = URL.createObjectURL(f);
                const img = document.createElement('img');
                img.src = url;
                img.style.width='100%'; img.style.height='140px';
                img.style.objectFit='cover'; img.style.borderRadius='6px';
                img.onload = () => URL.revokeObjectURL(url);
                const wrap = document.createElement('div'); wrap.style.padding='.25rem 0';
                wrap.appendChild(img); box.appendChild(wrap);
              });
            });
          }
        </script>
      </div>
      <div class="form-row row-2">
        <div><input type="url" name="full_url" placeholder="или URL изображения"></div>
        <label style="display:flex;gap:.4rem;align-items:center;">
          <input type="checkbox" name="is_default" value="1">
          Сделать главное
        </label>
      </div>
      <button type="submit">Загрузить</button>
    </form>

    <style>
      .photos {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-top: 1rem;
      }

      .photo-card {
        position: relative;
        background: #1b1e27;
        padding: .5rem;
        border-radius: 8px;
        width: 200px;
        transition: box-shadow .2s ease;
      }

      .photo-card img {
        width: 100%;
        height: 200px;
        object-fit: cover;
        border-radius: 6px;
      }

      .photo-card.selected {
        box-shadow: 0 0 0 3px rgba(77, 163, 255, 0.6);
      }

      .drag-handle {
        position: absolute;
        top: 6px;
        right: 8px;
        cursor: grab;
        opacity: .6;
        user-select: none;
      }

      .drag-handle:active {
        cursor: grabbing;
      }

      .badge-default {
        position: absolute;
        top: 6px;
        left: 8px;
        background: #dff4df;
        color: #1c6724;
        padding: .1rem .4rem;
        border-radius: .4rem;
        font-size: .75rem;
        font-weight: 600;
      }

      .select-checkbox {
        position: absolute;
        top: 8px;
        right: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        background: rgba(255, 255, 255, 0.12);
        border-radius: 4px;
      }

      .select-checkbox input {
        width: 16px;
        height: 16px;
        cursor: pointer;
      }

      .meta {
        margin-top: .35rem;
        font-size: .85rem;
        color: #99a;
      }

      .actions {
        display: flex;
        gap: .4rem;
        margin-top: .35rem;
        flex-wrap: wrap;
      }

      .icon-btn {
        background: none;
        border: none;
        padding: .15rem .4rem;
        font-size: 1.1rem;
        line-height: 1;
        cursor: pointer;
        color: #cfe;
      }

      .icon-btn:hover {
        opacity: .85;
      }

      .icon-btn.danger {
        color: #d66;
      }

      .icon-btn[disabled] {
        opacity: .5;
        cursor: wait;
      }

      .photo-bulk-actions {
        display: flex;
        flex-wrap: wrap;
        gap: .5rem;
        align-items: center;
        margin-top: 1rem;
      }

      .photo-bulk-actions .bulk-btn {
        padding: .35rem .75rem;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        background: #2a2f3d;
        color: #eef;
      }

      .photo-bulk-actions .bulk-btn[disabled] {
        opacity: .5;
        cursor: not-allowed;
      }

      .photo-bulk-actions .bulk-btn.danger {
        background: #7a2f36;
        color: #fff;
      }

      .photo-bulk-actions .selection-info {
        font-size: .85rem;
        color: #99a;
      }
    </style>

    {% if photos %}
    <div class="photo-bulk-actions" data-property-id="{{ prop.id }}" data-bulk-delete-url="{% url 'panel_photos_bulk_delete' %}">
      <button type="button" class="bulk-btn" id="photo-select-all">Выбрать все</button>
      <button type="button" class="bulk-btn" id="photo-clear-selection" disabled>Снять</button>
      <button type="button" class="bulk-btn danger" id="photo-delete-selected" disabled>Удалить выбранные</button>
      <button type="button" class="bulk-btn danger" id="photo-delete-all">Удалить все</button>
      <span class="selection-info" id="photo-selection-info"></span>
    </div>
    {% endif %}

    <div id="photos" class="photos" data-empty-text="Фото пока нет">
      {% for ph in photos %}
        <div class="photo-card" data-photo-id="{{ ph.id }}" data-rotate-url="{% url 'panel_photo_rotate' ph.id %}">
          <div class="drag-handle" title="Перетащить">⋮⋮</div>

          <label class="select-checkbox no-drag">
            <input type="checkbox" class="photo-select" value="{{ ph.id }}">
          </label>

          {% if ph.is_default %}
            <span class="badge-default">Главное</span>
          {% endif %}

          <img src="{{ ph.src }}" alt="" />

          <div class="meta">
            <span class="size">{{ ph.human_size }}</span>
          </div>

          <div class="actions">
            <button type="button" class="icon-btn" title="Повернуть влево" data-dir="left" data-action="rotate">↺</button>
            <button type="button" class="icon-btn" title="Повернуть вправо" data-dir="right" data-action="rotate">↻</button>
            <form class="no-drag" method="post" action="{% url 'panel_photo_set_default' ph.id %}" data-preserve-scroll="true">
              {% csrf_token %}
              <button type="submit" class="icon-btn" title="Сделать главным">
                {% if ph.is_default %}★{% else %}☆{% endif %}
              </button>
            </form>
            <form class="no-drag" method="post" action="{% url 'panel_photo_delete' ph.id %}" data-preserve-scroll="true">
              {% csrf_token %}
              <button type="submit" class="icon-btn danger" title="Удалить">✖</button>
            </form>
          </div>
        </div>
      {% empty %}
        <p>Фото пока нет</p>
      {% endfor %}
    </div>

    {% if photos %}
    <form id="reorderForm" method="post" action="{% url 'panel_photos_reorder' prop.id %}" style="margin-top:1rem;" data-preserve-scroll="true">
      {% csrf_token %}
      <input type="hidden" name="order" id="orderInput">
      <button type="submit">Сохранить порядок</button>
    </form>
    {% endif %}
  {% endif %}
{% endblock %}

{% block extra_scripts %}
  {{ block.super }}
  <script src="{% static 'core/form.js' %}"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script>
  document.addEventListener('DOMContentLoaded', function () {
    const list = document.getElementById('photos');
    if (!list) {
      return;
    }

    new Sortable(list, {
      handle: '.drag-handle',
      animation: 150,
      fallbackTolerance: 5,
    });

    const reorderForm = document.getElementById('reorderForm');
    if (!reorderForm) {
      return;
    }

    reorderForm.addEventListener('submit', function () {
      const ids = Array.from(document.querySelectorAll('#photos .photo-card')).map(
        (el) => el.dataset.photoId
      );
      const orderInput = document.getElementById('orderInput');
      if (orderInput) {
        orderInput.value = ids.join(',');
      }
    });
  });
  </script>
{% endblock %}
