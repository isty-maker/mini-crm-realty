{% extends "base.html" %}
{% load static %}
{% block title %}{{ prop|default:"Новый объект" }} — Мини-CRM{% endblock %}
{% block content %}
  <a href="/panel/">&larr; к списку</a>
  <h1>{{ prop|default:"Новый объект" }}</h1>

  <form id="prop-form" method="post" action="{% if prop %}{% url 'panel_edit' pk=prop.id %}{% else %}{% url 'panel_create' %}{% endif %}">
    {% csrf_token %}
    {{ form.non_field_errors }}
    {% if form.errors %}
      <div class="alert alert-danger">
        <strong>Исправьте ошибки:</strong>
        <ul>
        {% for field in form %}
          {% if field.errors %}
            <li><a href="#{{ field.id_for_label }}">{{ field.label }}:</a> {{ field.errors|join:", " }}</li>
          {% endif %}
        {% endfor %}
        {% if form.non_field_errors %}
          {% for e in form.non_field_errors %}
            <li>{{ e }}</li>
          {% endfor %}
        {% endif %}
        </ul>
      </div>
    {% endif %}
    <div id="subtypes-data"
         data-subtypes='{{ subtypes_map_json|default:"{}"|safe }}'
         data-placeholder="{{ subtypes_placeholder }}"
         hidden></div>
    <section class="group">
      <h3>Тип и сделка</h3>
      {% with field=form.category %}
      <div class="form-row">
        {{ field.label_tag }} {{ field }}
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.operation %}
      <div class="form-row">
        {{ field.label_tag }} {{ field }}
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.subtype %}
      <div class="form-row">
        {{ field.label_tag }} {{ field }}
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
    </section>

    <section class="group">
      <h3>Экспорт</h3>
      {% with field=form.status %}
      <div class="form-row">
        {{ field.label_tag }} {{ field }}
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.export_to_cian %}
      <div class="form-row">
        <label>{{ field }} {{ field.label }}</label>
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.export_to_domklik %}
      <div class="form-row">
        <label>{{ field }} {{ field.label }}</label>
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.is_archived %}
      <div class="form-row">
        <label>{{ field }} {{ field.label }}</label>
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
    </section>

    <!-- Общие поля (видны всегда) -->
    <section class="group">
      <h3>Основное</h3>
      <div class="form-row">{{ form.title.label_tag }} {{ form.title }}{% if form.title.errors %}<div class="field-error">{{ form.title.errors|join:", " }}</div>{% endif %}</div>
      <div class="form-row row-2">
        {{ form.price.label_tag }} {{ form.price }}{% if form.price.errors %}<div class="field-error">{{ form.price.errors|join:", " }}</div>{% endif %}
        {{ form.currency.label_tag }} {{ form.currency }}{% if form.currency.errors %}<div class="field-error">{{ form.currency.errors|join:", " }}</div>{% endif %}
      </div>
      <div class="form-row">{{ form.address.label_tag }} {{ form.address }}{% if form.address.errors %}<div class="field-error">{{ form.address.errors|join:", " }}</div>{% endif %}</div>
      <div class="form-row">{{ form.description.label_tag }} {{ form.description }}{% if form.description.errors %}<div class="field-error">{{ form.description.errors|join:", " }}</div>{% endif %}</div>
      <div class="form-row">
        <label>{{ form.mortgage_allowed }} {{ form.mortgage_allowed.label }}</label>{% if form.mortgage_allowed.errors %}<div class="field-error">{{ form.mortgage_allowed.errors|join:", " }}</div>{% endif %}
      </div>
      <div class="form-row row-2">
        <div class="form-row">
          {{ form.agent_bonus_value.label_tag }}
          {{ form.agent_bonus_value }}{% if form.agent_bonus_value.errors %}<div class="field-error">{{ form.agent_bonus_value.errors|join:", " }}</div>{% endif %}
        </div>
        <div class="form-row">
          <label>{{ form.agent_bonus_is_percent }} {{ form.agent_bonus_is_percent.label }}</label>{% if form.agent_bonus_is_percent.errors %}<div class="field-error">{{ form.agent_bonus_is_percent.errors|join:", " }}</div>{% endif %}
        </div>
      </div>
      <div class="form-row row-2">
        <div class="form-row">
          {{ form.security_deposit.label_tag }}
          {{ form.security_deposit }}{% if form.security_deposit.errors %}<div class="field-error">{{ form.security_deposit.errors|join:", " }}</div>{% endif %}
        </div>
        <div class="form-row">
          {{ form.min_rent_term_months.label_tag }}
          {{ form.min_rent_term_months }}{% if form.min_rent_term_months.errors %}<div class="field-error">{{ form.min_rent_term_months.errors|join:", " }}</div>{% endif %}
        </div>
      </div>
    </section>

    <section class="group">
      <h3>Адрес</h3>
      <div class="form-row row-2">
        <div class="form-row">
          {{ form.lat.label_tag }}
          {{ form.lat }}{% if form.lat.errors %}<div class="field-error">{{ form.lat.errors|join:", " }}</div>{% endif %}
        </div>
        <div class="form-row">
          {{ form.lng.label_tag }}
          {{ form.lng }}{% if form.lng.errors %}<div class="field-error">{{ form.lng.errors|join:", " }}</div>{% endif %}
        </div>
      </div>
      <div class="form-row">
        {{ form.cadastral_number.label_tag }}
        {{ form.cadastral_number }}{% if form.cadastral_number.errors %}<div class="field-error">{{ form.cadastral_number.errors|join:", " }}</div>{% endif %}
      </div>
    </section>

    <section class="group">
      <h3>Контакты</h3>
      <div class="form-row row-2">
        <div class="form-row">
          {{ form.phone_country.label_tag }}
          {{ form.phone_country }}{% if form.phone_country.errors %}<div class="field-error">{{ form.phone_country.errors|join:", " }}</div>{% endif %}
        </div>
        <div class="form-row">
          {{ form.phone_number.label_tag }}
          {{ form.phone_number }}{% if form.phone_number.errors %}<div class="field-error">{{ form.phone_number.errors|join:", " }}</div>{% endif %}
        </div>
      </div>
      <div class="form-row">
        {{ form.phone_number2.label_tag }}
        {{ form.phone_number2 }}{% if form.phone_number2.errors %}<div class="field-error">{{ form.phone_number2.errors|join:", " }}</div>{% endif %}
      </div>
    </section>

    <section class="group">
      <h3>Медиа</h3>
      <div class="form-row">
        {{ form.layout_photo_url.label_tag }}
        {{ form.layout_photo_url }}{% if form.layout_photo_url.errors %}<div class="field-error">{{ form.layout_photo_url.errors|join:", " }}</div>{% endif %}
      </div>
      <div class="form-row">
        {{ form.object_tour_url.label_tag }}
        {{ form.object_tour_url }}{% if form.object_tour_url.errors %}<div class="field-error">{{ form.object_tour_url.errors|join:", " }}</div>{% endif %}
      </div>
    </section>

    <section class="group">
      <h3>Здание</h3>
      <div class="form-row">
        {{ form.building_name.label_tag }}
        {{ form.building_name }}{% if form.building_name.errors %}<div class="field-error">{{ form.building_name.errors|join:", " }}</div>{% endif %}
      </div>
      <div class="form-row row-2">
        <div class="form-row">
          {{ form.building_floors.label_tag }}
          {{ form.building_floors }}{% if form.building_floors.errors %}<div class="field-error">{{ form.building_floors.errors|join:", " }}</div>{% endif %}
        </div>
        <div class="form-row">
          {{ form.building_build_year.label_tag }}
          {{ form.building_build_year }}{% if form.building_build_year.errors %}<div class="field-error">{{ form.building_build_year.errors|join:", " }}</div>{% endif %}
        </div>
      </div>
      <div class="form-row">
        {{ form.building_material.label_tag }}
        {{ form.building_material }}{% if form.building_material.errors %}<div class="field-error">{{ form.building_material.errors|join:", " }}</div>{% endif %}
      </div>
      <div class="form-row row-2">
        <div class="form-row">
          {{ form.building_ceiling_height.label_tag }}
          {{ form.building_ceiling_height }}{% if form.building_ceiling_height.errors %}<div class="field-error">{{ form.building_ceiling_height.errors|join:", " }}</div>{% endif %}
        </div>
        <div class="form-row">
          {{ form.building_passenger_lifts.label_tag }}
          {{ form.building_passenger_lifts }}{% if form.building_passenger_lifts.errors %}<div class="field-error">{{ form.building_passenger_lifts.errors|join:", " }}</div>{% endif %}
        </div>
      </div>
      <div class="form-row">
        {{ form.building_cargo_lifts.label_tag }}
        {{ form.building_cargo_lifts }}{% if form.building_cargo_lifts.errors %}<div class="field-error">{{ form.building_cargo_lifts.errors|join:", " }}</div>{% endif %}
      </div>
    </section>

    <div class="group category-section category-section--house" data-section="house" data-category="house">
      <h3>Параметры дома</h3>
      {% if form.fields.house_type %}
      <div class="form-row">
        <label for="{{ form.house_type.id_for_label }}">{{ form.house_type.label }}</label>
        {{ form.house_type }}
        {% if form.house_type.errors %}<div class="field-error">{{ form.house_type.errors|join:", " }}</div>{% endif %}
      </div>
      {% endif %}
      {% with field=form.total_area %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.living_area %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.kitchen_area %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.land_area %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.land_area_unit %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.permitted_land_use %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.is_land_with_contract %}
      <div class="form-row">
        <label>
          {{ field }} {{ field.label }}
        </label>
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.land_category %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.heating_type %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.has_terrace %}
      <div class="form-row">
        <label>{{ field }} {{ field.label }}</label>
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.has_cellar %}
      <div class="form-row">
        <label>{{ field }} {{ field.label }}</label>
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.rooms %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.repair_type %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.separate_wcs_count %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.combined_wcs_count %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.ceiling_height %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.power %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.has_parking %}
      <div class="form-row">
        <label>{{ field }} {{ field.label }}</label>
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.parking_places %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
    </div>

    <div class="group category-section category-section--flat" data-section="flat" data-category="flat">
      <h3>Квартира</h3>
      {% if form.fields.flat_type %}
      <div class="form-row">
        <label for="{{ form.flat_type.id_for_label }}">{{ form.flat_type.label }}</label>
        {{ form.flat_type }}
        {% if form.flat_type.errors %}<div class="field-error">{{ form.flat_type.errors|join:", " }}</div>{% endif %}
      </div>
      {% endif %}
      {% with field=form.total_area %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.living_area %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.kitchen_area %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.rooms %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.floor_number %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.room_type %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.flat_rooms_count %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      <div class="form-row row-2">
        {% with field=form.loggias_count %}
        <div class="form-row">
          <label for="{{ field.id_for_label }}">{{ field.label }}</label>
          {{ field }}
          {% include "core/includes/field_errors.html" %}
        </div>
        {% endwith %}
        {% with field=form.balconies_count %}
        <div class="form-row">
          <label for="{{ field.id_for_label }}">{{ field.label }}</label>
          {{ field }}
          {% include "core/includes/field_errors.html" %}
        </div>
        {% endwith %}
      </div>
      {% with field=form.windows_view_type %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      <div class="form-row row-2">
        {% with field=form.separate_wcs_count %}
        <div class="form-row">
          <label for="{{ field.id_for_label }}">{{ field.label }}</label>
          {{ field }}
          {% include "core/includes/field_errors.html" %}
        </div>
        {% endwith %}
        {% with field=form.combined_wcs_count %}
        <div class="form-row">
          <label for="{{ field.id_for_label }}">{{ field.label }}</label>
          {{ field }}
          {% include "core/includes/field_errors.html" %}
        </div>
        {% endwith %}
      </div>
      {% with field=form.repair_type %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.is_euro_flat %}
      <div class="form-row">
        <label>{{ field }} {{ field.label }}</label>
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.is_apartments %}
      <div class="form-row">
        <label>{{ field }} {{ field.label }}</label>
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.is_penthouse %}
      <div class="form-row">
        <label>{{ field }} {{ field.label }}</label>
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      <div class="form-row">
        <label for="{{ form.jk_id.id_for_label }}">{{ form.jk_id.label }}</label>
        {{ form.jk_id }}
        {% if form.jk_id.errors %}<div class="field-error">{{ form.jk_id.errors|join:", " }}</div>{% endif %}
      </div>
      <div class="form-row">
        <label for="{{ form.jk_name.id_for_label }}">{{ form.jk_name.label }}</label>
        {{ form.jk_name }}
        {% if form.jk_name.errors %}<div class="field-error">{{ form.jk_name.errors|join:", " }}</div>{% endif %}
      </div>
      <div class="form-row">
        <label for="{{ form.house_id.id_for_label }}">{{ form.house_id.label }}</label>
        {{ form.house_id }}
        {% if form.house_id.errors %}<div class="field-error">{{ form.house_id.errors|join:", " }}</div>{% endif %}
      </div>
      <div class="form-row">
        <label for="{{ form.house_name.id_for_label }}">{{ form.house_name.label }}</label>
        {{ form.house_name }}
        {% if form.house_name.errors %}<div class="field-error">{{ form.house_name.errors|join:", " }}</div>{% endif %}
      </div>
      <div class="form-row">
        <label for="{{ form.flat_number.id_for_label }}">{{ form.flat_number.label }}</label>
        {{ form.flat_number }}
        {% if form.flat_number.errors %}<div class="field-error">{{ form.flat_number.errors|join:", " }}</div>{% endif %}
      </div>
      <div class="form-row">
        <label for="{{ form.section_number.id_for_label }}">{{ form.section_number.label }}</label>
        {{ form.section_number }}
        {% if form.section_number.errors %}<div class="field-error">{{ form.section_number.errors|join:", " }}</div>{% endif %}
      </div>
    </div>

    <div class="group category-section category-section--room" data-section="room" data-category="room">
      <h3>Комната</h3>
      {% if form.fields.room_type_ext %}
      <div class="form-row">
        <label for="{{ form.room_type_ext.id_for_label }}">{{ form.room_type_ext.label }}</label>
        {{ form.room_type_ext }}
        {% if form.room_type_ext.errors %}<div class="field-error">{{ form.room_type_ext.errors|join:", " }}</div>{% endif %}
      </div>
      {% endif %}
      {% with field=form.total_area %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.living_area %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.rooms %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.floor_number %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.room_type %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      <div class="form-row row-2">
        {% with field=form.separate_wcs_count %}
        <div class="form-row">
          <label for="{{ field.id_for_label }}">{{ field.label }}</label>
          {{ field }}
          {% include "core/includes/field_errors.html" %}
        </div>
        {% endwith %}
        {% with field=form.combined_wcs_count %}
        <div class="form-row">
          <label for="{{ field.id_for_label }}">{{ field.label }}</label>
          {{ field }}
          {% include "core/includes/field_errors.html" %}
        </div>
        {% endwith %}
      </div>
      {% with field=form.repair_type %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      <div class="form-row">
        <label for="{{ form.jk_id.id_for_label }}">{{ form.jk_id.label }}</label>
        {{ form.jk_id }}
        {% if form.jk_id.errors %}<div class="field-error">{{ form.jk_id.errors|join:", " }}</div>{% endif %}
      </div>
      <div class="form-row">
        <label for="{{ form.jk_name.id_for_label }}">{{ form.jk_name.label }}</label>
        {{ form.jk_name }}
        {% if form.jk_name.errors %}<div class="field-error">{{ form.jk_name.errors|join:", " }}</div>{% endif %}
      </div>
      <div class="form-row">
        <label for="{{ form.house_id.id_for_label }}">{{ form.house_id.label }}</label>
        {{ form.house_id }}
        {% if form.house_id.errors %}<div class="field-error">{{ form.house_id.errors|join:", " }}</div>{% endif %}
      </div>
      <div class="form-row">
        <label for="{{ form.house_name.id_for_label }}">{{ form.house_name.label }}</label>
        {{ form.house_name }}
        {% if form.house_name.errors %}<div class="field-error">{{ form.house_name.errors|join:", " }}</div>{% endif %}
      </div>
      <div class="form-row">
        <label for="{{ form.flat_number.id_for_label }}">{{ form.flat_number.label }}</label>
        {{ form.flat_number }}
        {% if form.flat_number.errors %}<div class="field-error">{{ form.flat_number.errors|join:", " }}</div>{% endif %}
      </div>
      <div class="form-row">
        <label for="{{ form.section_number.id_for_label }}">{{ form.section_number.label }}</label>
        {{ form.section_number }}
        {% if form.section_number.errors %}<div class="field-error">{{ form.section_number.errors|join:", " }}</div>{% endif %}
      </div>
    </div>

    <div class="group category-section category-section--commercial" data-section="commercial" data-category="commercial">
      <h3>Коммерция</h3>
      {% if form.fields.commercial_type %}
      <div class="form-row">
        <label for="{{ form.commercial_type.id_for_label }}">{{ form.commercial_type.label }}</label>
        {{ form.commercial_type }}
        {% if form.commercial_type.errors %}<div class="field-error">{{ form.commercial_type.errors|join:", " }}</div>{% endif %}
      </div>
      {% endif %}
      {% with field=form.total_area %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.ceiling_height %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.power %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.has_parking %}
      <div class="form-row">
        <label>{{ field }} {{ field.label }}</label>
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.parking_places %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.has_ramp %}
      <div class="form-row">
        <label>{{ field }} {{ field.label }}</label>
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.is_rent_by_parts %}
      <div class="form-row">
        <label>{{ field }} {{ field.label }}</label>
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.rent_by_parts_desc %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
    </div>

    <div class="group category-section category-section--land" data-section="land" data-category="land">
      <h3>Земельный участок</h3>
      {% if form.fields.land_type %}
      <div class="form-row">
        <label for="{{ form.land_type.id_for_label }}">{{ form.land_type.label }}</label>
        {{ form.land_type }}
        {% if form.land_type.errors %}<div class="field-error">{{ form.land_type.errors|join:", " }}</div>{% endif %}
      </div>
      {% endif %}
      {% with field=form.land_area %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.land_area_unit %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.permitted_land_use %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.land_category %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.is_land_with_contract %}
      <div class="form-row">
        <label>{{ field }} {{ field.label }}</label>
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
    </div>

    <div class="group category-section category-section--garage" data-section="garage" data-category="garage">
      <h3>Гараж</h3>
      {% with field=form.total_area %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.has_parking %}
      <div class="form-row">
        <label>{{ field }} {{ field.label }}</label>
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.parking_places %}
      <div class="form-row">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
    </div>

    <section class="group">
      <h3>Удобства</h3>
      <div class="form-row">
        <label for="{{ form.furnishing_details.id_for_label }}">{{ form.furnishing_details.label }}</label>
        {{ form.furnishing_details }}
        {% if form.furnishing_details.errors %}<div class="field-error">{{ form.furnishing_details.errors|join:", " }}</div>{% endif %}
      </div>
      <div class="form-row">
        <label>{{ form.has_internet }} {{ form.has_internet.label }}</label>
      </div>
      <div class="form-row">
        <label>{{ form.has_furniture }} {{ form.has_furniture.label }}</label>
      </div>
      <div class="form-row">
        <label>{{ form.has_kitchen_furniture }} {{ form.has_kitchen_furniture.label }}</label>
      </div>
      <div class="form-row">
        <label>{{ form.has_tv }} {{ form.has_tv.label }}</label>
      </div>
      <div class="form-row">
        <label>{{ form.has_washer }} {{ form.has_washer.label }}</label>
      </div>
      <div class="form-row">
        <label>{{ form.has_conditioner }} {{ form.has_conditioner.label }}</label>
      </div>
      <div class="form-row">
        <label>{{ form.has_refrigerator }} {{ form.has_refrigerator.label }}</label>
      </div>
      <div class="form-row">
        <label>{{ form.has_dishwasher }} {{ form.has_dishwasher.label }}</label>
      </div>
      <div class="form-row">
        <label>{{ form.has_shower }} {{ form.has_shower.label }}</label>
      </div>
      <div class="form-row">
        <label>{{ form.has_phone }} {{ form.has_phone.label }}</label>
      </div>
      <div class="form-row">
        <label>{{ form.has_bathtub }} {{ form.has_bathtub.label }}</label>
      </div>
    </section>

    <button type="submit">Сохранить</button>
  </form>

  {% if prop %}
    <hr>
    <h3>Фотографии</h3>
    <form action="{% url 'panel_add_photo' pk=prop.id %}" method="post" enctype="multipart/form-data">
      {% csrf_token %}
      <input type="file" id="photo-input" name="image" accept="image/*">
      <input type="url" name="full_url" placeholder="https://example.com/photo.jpg" style="margin-left:.5rem; min-width: 260px;">
      <label style="margin-left:.5rem;">
        <input type="checkbox" name="is_default"> Сделать главным
      </label>
      <button type="submit">Загрузить</button>
    </form>

    <div id="photo-preview-wrapper">
      <img id="photo-preview" style="max-width: 320px; display:none;" alt="preview">
    </div>

    <div id="photos" class="panel-photos" style="display:flex; flex-wrap:wrap; gap:1rem; margin-top:1rem;">
      {% for ph in photos %}
        <div class="panel-photo" data-photo-id="{{ ph.id }}" style="border:1px solid #ddd; padding:.5rem; max-width:200px;">
          {% if ph.is_default %}<div style="font-weight:bold; margin-bottom:.25rem;">[главное]</div>{% endif %}
          {% if ph.src %}
            <img src="{{ ph.src }}" alt="" style="max-width: 100%; height:auto; display:block;">
          {% endif %}
          <div class="photo-actions" style="display:flex; gap:.4rem; flex-wrap:wrap; margin-top:.5rem;">
            <button type="button" class="photo-move" data-action="up" title="Переместить вверх">↑</button>
            <button type="button" class="photo-move" data-action="down" title="Переместить вниз">↓</button>
            <a href="{% url 'panel_toggle_main' photo_id=ph.id %}">сделать главным</a>
            <form method="post" action="{% url 'panel_photo_delete' pk=ph.id %}" style="margin:0;">
              {% csrf_token %}
              <button class="secondary" type="submit">Удалить</button>
            </form>
          </div>
        </div>
      {% empty %}
        <p>Фото пока нет</p>
      {% endfor %}
    </div>

    {% if photos %}
    <form id="reorderForm" method="post" action="{% url 'panel_photos_reorder' prop_id=prop.id %}" style="margin-top:1rem;">
      {% csrf_token %}
      <input type="hidden" name="order" id="orderInput">
      <button type="submit">Сохранить порядок</button>
    </form>
    {% endif %}
  {% endif %}
{% endblock %}

{% block extra_scripts %}
  {{ block.super }}
  <script src="{% static 'core/form.js' %}"></script>
  <script>
  document.addEventListener("DOMContentLoaded", function () {
    var input = document.getElementById("photo-input");
    var img = document.getElementById("photo-preview");
    if (!input || !img) return;
    input.addEventListener("change", function (e) {
      const file = e.target.files && e.target.files[0];
      if (!file) { img.style.display = "none"; return; }
      const reader = new FileReader();
      reader.onload = function (ev) {
        img.src = ev.target.result;
        img.style.display = "block";
      };
      reader.readAsDataURL(file);
    });
    const photosContainer = document.getElementById('photos');
    if (photosContainer) {
      photosContainer.addEventListener('click', function (event) {
        const btn = event.target.closest('button.photo-move');
        if (!btn) return;
        event.preventDefault();
        const card = btn.closest('.panel-photo');
        if (!card) return;
        if (btn.dataset.action === 'up') {
          const prev = card.previousElementSibling;
          if (prev) {
            photosContainer.insertBefore(card, prev);
          }
        } else if (btn.dataset.action === 'down') {
          const next = card.nextElementSibling;
          if (next) {
            photosContainer.insertBefore(next, card);
          }
        }
      });
    }

    const reorderForm = document.getElementById('reorderForm');
    if (reorderForm) {
      reorderForm.addEventListener('submit', function (e) {
        const ids = Array.from(document.querySelectorAll('#photos .panel-photo'))
          .map(function (el) { return el.dataset.photoId; })
          .filter(function (id) { return id; });
        document.getElementById('orderInput').value = ids.join(',');
      });
    }
  });
  </script>
{% endblock %}
