{% extends "base.html" %}
{% load static %}
{% block title %}{{ prop|default:"Новый объект" }} — Мини-CRM{% endblock %}
{% block extra_head %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'core/panel.css' %}">
{% endblock %}
{% block content %}
  <a href="/panel/">&larr; к списку</a>
  <h1>{{ prop|default:"Новый объект" }}</h1>

  <form id="prop-form" method="post" action="{% if prop %}{% url 'panel_edit' pk=prop.id %}{% else %}{% url 'panel_create' %}{% endif %}" data-preserve-scroll="true">
    {% csrf_token %}
    {{ form.non_field_errors }}
    {% for hidden in form.hidden_fields %}
      {{ hidden }}
    {% endfor %}
    {% if form.errors %}
      <div class="alert alert-danger">
        <strong>Исправьте ошибки:</strong>
        <ul>
        {% for field in form %}
          {% if field.errors %}
            <li><a href="#{{ field.id_for_label }}">{{ field.label }}:</a> {{ field.errors|join:", " }}</li>
          {% endif %}
        {% endfor %}
        {% if form.non_field_errors %}
          {% for e in form.non_field_errors %}
            <li>{{ e }}</li>
          {% endfor %}
        {% endif %}
        </ul>
      </div>
    {% endif %}
    <div id="subtypes-data"
         data-subtypes='{{ subtypes_map_json|default:"{}"|safe }}'
         data-placeholder="{{ subtypes_placeholder }}"
         hidden></div>
    <section class="group">
      <h3>Тип и сделка</h3>
      {% with field=form.category %}
      <div class="form-row">
        {{ field.label_tag }} {{ field }}
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.operation %}
      <div class="form-row">
        {{ field.label_tag }} {{ field }}
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.subtype %}
      <div class="form-row">
        {{ field.label_tag }} {{ field }}
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
    </section>

    <section class="group">
      <h3>Экспорт</h3>
      {% with field=form.status %}
      <div class="form-row">
        {{ field.label_tag }} {{ field }}
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.export_to_cian %}
      <div class="form-row">
        <label>{{ field }} {{ field.label }}</label>
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.export_to_domklik %}
      <div class="form-row">
        <label>{{ field }} {{ field.label }}</label>
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
      {% with field=form.is_archived %}
      <div class="form-row">
        <label>{{ field }} {{ field.label }}</label>
        {% include "core/includes/field_errors.html" %}
      </div>
      {% endwith %}
    </section>

    {% for group_title, fields in field_groups %}
      <section class="group">
        <h3>{{ group_title }}</h3>
        {% for field in fields %}
          {% if not field.is_hidden %}
          <div class="form-row">
            {% if field.field.widget.input_type == "checkbox" %}
              <label>{{ field }} {{ field.label }}</label>
            {% else %}
              {{ field.label_tag }} {{ field }}
            {% endif %}
            {% include "core/includes/field_errors.html" %}
          </div>
          {% endif %}
        {% endfor %}
      </section>
    {% endfor %}

    {% if field_fallback %}
    <section class="group">
      <h3>Прочее</h3>
      {% for field in field_fallback %}
        {% if not field.is_hidden %}
        <div class="form-row">
          {% if field.field.widget.input_type == "checkbox" %}
            <label>{{ field }} {{ field.label }}</label>
          {% else %}
            {{ field.label_tag }} {{ field }}
          {% endif %}
          {% include "core/includes/field_errors.html" %}
        </div>
        {% endif %}
      {% endfor %}
    </section>
    {% endif %}
    <button type="submit">Сохранить</button>
  </form>

  {% if prop %}
    <hr>
    <h3>Фотографии</h3>

    <div class="photo-bulk-actions"
         data-bulk-delete-url="{% url 'panel_photos_bulk_delete' %}"
         data-property-id="{% if prop %}{{ prop.id }}{% endif %}">
      <button type="button" id="photo-select-all">Выбрать все</button>
      <button type="button" id="photo-clear-selection">Снять</button>
      <button type="button" id="photo-delete-selected" disabled>Удалить выбранные</button>
      <button type="button" id="photo-delete-all" {% if not photos %}disabled{% endif %}>Удалить все</button>
      <span id="photo-selection-info"></span>
    </div>

    <form id="uploadForm" method="post" enctype="multipart/form-data" action="{% url 'panel_add_photo' prop.id %}">
      {% csrf_token %}
      <label>Файлы (можно выбрать несколько)</label>
      <input type="file" name="images" multiple>
      <button type="submit">Загрузить</button>
    </form>

    <div id="photos" data-empty-text="Фото пока нет">
      {% for ph in photos %}
        <div class="photo-card{% if not ph.image %} no-rotate{% endif %}"
             data-photo-id="{{ ph.id }}"
             {% if ph.image %}data-rotate-url="{% url 'panel_photo_rotate' ph.id %}"{% endif %}>
          <label class="photo-thumb">
            <input type="checkbox" class="photo-select" value="{{ ph.id }}">
            <img src="{{ ph.src }}" alt="Фото {{ forloop.counter }}">
          </label>

          <div class="photo-actions">
            {% if ph.image %}
            <button type="button" data-action="rotate" data-dir="left" title="Повернуть влево">↺</button>
            <button type="button" data-action="rotate" data-dir="right" title="Повернуть вправо">↻</button>
            {% endif %}

            <form method="post" action="{% url 'panel_photo_set_default' ph.id %}">
              {% csrf_token %}
              <button type="submit" title="Сделать главным">{% if ph.is_default %}★{% else %}☆{% endif %}</button>
            </form>

            <form method="post" action="{% url 'panel_photo_delete' ph.id %}">
              {% csrf_token %}
              <button type="submit" title="Удалить">✖</button>
            </form>

            <span class="size">{{ ph.human_size }}</span>
            {% if ph.is_default %}<span class="badge">Главное</span>{% endif %}
          </div>
        </div>
      {% empty %}
        <!-- Пустое состояние отрисует JS через data-empty-text -->
      {% endfor %}
    </div>

    {% if photos %}
    <form id="reorderForm" method="post" action="{% url 'panel_photos_reorder' prop.id %}">
      {% csrf_token %}
      <input type="hidden" name="order" value="">
      <button type="submit">Сохранить порядок</button>
    </form>
    {% endif %}
  {% endif %}
{% endblock %}

{% block extra_scripts %}
  {{ block.super }}
  <script src="{% static 'core/form.js' %}"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script>
  document.addEventListener('DOMContentLoaded', function () {
    const list = document.getElementById('photos');
    if (!list) {
      return;
    }

    new Sortable(list, {
      animation: 150,
      fallbackTolerance: 5,
    });

    const reorderForm = document.getElementById('reorderForm');
    if (!reorderForm) {
      return;
    }

    reorderForm.addEventListener('submit', function () {
      const ids = Array.from(document.querySelectorAll('#photos .photo-card')).map(
        (el) => el.dataset.photoId
      );
      const orderInput = reorderForm.querySelector('input[name="order"]');
      if (orderInput) {
        orderInput.value = ids.join(',');
      }
    });
  });
  </script>
  <script>
    (function () {
      var isNew = {% if prop %}false{% else %}true{% endif %};
      if (!isNew) {
        return;
      }
      var cat = document.querySelector('select[name="category"]');
      var op = document.querySelector('select[name="operation"]');
      var subtype = document.querySelector('select[name="subtype"]');

      function reload(event) {
        var params = new URLSearchParams(window.location.search);
        if (cat) {
          if (cat.value) {
            params.set('category', cat.value);
          } else {
            params.delete('category');
          }
        }
        if (op) {
          if (op.value) {
            params.set('operation', op.value);
          } else {
            params.delete('operation');
          }
        }
        if (subtype) {
          if (event && event.target === cat) {
            params.delete('subtype');
          } else if (subtype.value) {
            params.set('subtype', subtype.value);
          } else {
            params.delete('subtype');
          }
        }
        var basePath = window.location.pathname;
        if (basePath.indexOf('/panel/create/') === -1) {
          basePath = '/panel/create/';
        }
        var query = params.toString();
        window.location.href = query ? basePath + '?' + query : basePath;
      }

      if (cat) {
        cat.addEventListener('change', reload);
      }
      if (op) {
        op.addEventListener('change', reload);
      }
    })();
  </script>
{% endblock %}
